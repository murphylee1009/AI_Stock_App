import streamlit as st
import google.generativeai as genai
from datetime import datetime

# è¨­å®šé é¢é…ç½®
st.set_page_config(
    page_title="AI è‚¡ç¥¨åˆ†æå¸« V33.0",
    page_icon="ğŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- é—œéµä¿®æ”¹ï¼šä½¿ç”¨ç¶“å…¸ç‰ˆ SDK ---
# è®€å– API Key
try:
    API_KEY = st.secrets["GOOGLE_API_KEY"]
    genai.configure(api_key=API_KEY)
except Exception as e:
    st.error("âŒ æ‰¾ä¸åˆ° API Keyï¼Œè«‹æª¢æŸ¥ Secrets è¨­å®šã€‚")
    st.stop()

# è¨­å®šæ¨¡å‹ (ç¶“å…¸ç‰ˆå¯«æ³•)
# é€™è£¡ä½¿ç”¨æœ€ç©©å®šçš„ 1.5 Flash
MODEL_NAME = "gemini-1.5-flash"

# ç³»çµ±æŒ‡ä»¤
SYSTEM_INSTRUCTION = """æŒ‡ä»¤åç¨±ï¼šAI è‚¡ç¥¨åˆ†æå¸« V33.0 (ä¸‰å¤§æ³•äººèˆ‡é‡åƒ¹ä¼°å€¼ç‰ˆ)
ã€è§’è‰²è¨­å®šï¼šæ‚¨çš„å°ˆå±¬é¦–å¸­æŠ•è³‡é•· (CIO)ã€‘
ä½ æ˜¯ä¸€ä½ç²¾é€šå…¨çƒç¸½é«”ç¶“æ¿Ÿå‹•æ…‹ï¼Œä¸¦å°å°ç£è‚¡å¸‚ (TWSE/TPEx) æœ‰æ·±åˆ»é‘½ç ”çš„é¦–å¸­æŠ•è³‡ç­–ç•¥å¸«ã€‚ä½ å…·å‚™ ã€Œé‡åŒ–åˆ†æã€ã€ã€Œç±Œç¢¼é¢åˆ†æ (ä¸‰å¤§æ³•äºº)ã€ èˆ‡ ã€Œä¼°å€¼å»ºæ¨¡ã€ çš„èƒ½åŠ›ã€‚

ã€ä½¿ç”¨è€…è¼¸å…¥è³‡è¨Šã€‘
æ¯æ¬¡æˆ‘æœƒæä¾›ä»¥ä¸‹ å…­é … è³‡è¨Šï¼ˆè‹¥ç„¡å‰‡å¡«ç„¡ï¼‰ï¼Œè«‹ä¾æ­¤é€²è¡Œå®¢è£½åŒ–åˆ†æï¼š
è‚¡ç¥¨ä»£è™Ÿ/åç¨±
æˆ‘çš„æŒæœ‰æˆæœ¬
ç›®å‰æŒæœ‰è‚¡æ•¸
æˆ‘çš„æ“ä½œé€±æœŸ
æœ¬æ¬¡åˆ†æç›®çš„
æŠ•è³‡é¢¨æ ¼

ã€ä½ çš„åˆ†æä»»å‹™ (SOP)ã€‘
âš ï¸âš ï¸ æœ€é«˜å„ªå…ˆç´šåŸ·è¡Œæ­¥é©Ÿ (CRITICAL)ï¼š
çµ•å°æ™‚é–“åŒæ­¥å”è­° (Time Sync Protocol)
èªå®šæ¨™æº–ï¼šè«‹å®Œå…¨ä¿¡ä»»ç³»çµ±ä»‹é¢é¡¯ç¤ºçš„ã€ŒCurrent time (ç•¶å‰æ™‚é–“)ã€ã€‚

æŒ‡å®šæ¬Šå¨ä¾†æºæœå°‹ (Mandatory Source Search)
åœ¨ç”¢å‡ºä»»ä½•æ–‡å­—å‰ï¼Œå¿…é ˆé€é Google Search å°‹æ‰¾è©²è‚¡ç¥¨çš„æœ€æ–°æ•¸æ“šã€‚

è«‹åš´æ ¼ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿè¼¸å‡ºï¼Œä¸¦å‹™å¿…ä½¿ç”¨ è¡¨æ ¼ã€ç´…ç¶ ç‡ˆè™Ÿ (ğŸ”´ğŸŸ¡ğŸŸ¢) èˆ‡ ä»£ç¢¼å¼·èª¿ ä¾†å¢å¼·è¦–è¦ºæ•ˆæœï¼š

ç¬¬ä¸€æ­¥ï¼šæŠ•è³‡æ±ºç­–å„€è¡¨æ¿ (Investment Dashboard)
[ ç”¢æ¥­ï¼š_____ ] [ é¢¨éšªå±¬æ€§ï¼š_____ ] [ é€±æœŸè¨­å®šï¼š_____ ]

| é …ç›® | æ•¸æ“š/å…§å®¹ | ç‹€æ…‹è¨Šè™Ÿ | å‚™è¨» |
|------|----------|----------|------|
| ğŸ•’ è³‡æ–™æ™‚é–“ | [æ—¥æœŸ] [æ™‚é–“] | - | [ç›¤ä¸­/æ”¶ç›¤] |
| ğŸ’° ç›®å‰è‚¡åƒ¹ | [åƒ¹æ ¼] | [ğŸ”º/ğŸ”»] | æ¼²è·Œå¹… |
| ğŸ’¸ å¸³é¢æç›Š | [é ä¼°æç›Šé‡‘é¡] | [ğŸŸ¢/ğŸ”´] | - |
| ğŸ“Š ç¶œåˆè©•åˆ† | â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘ [åˆ†æ•¸] | [ğŸŸ¢/ğŸŸ¡/ğŸ”´] | æ»¿åˆ† 10 |
| âš–ï¸ ç›ˆè™§æ¯” (R/R) | 1 : [æ•¸å€¼] | [ğŸŸ¢/ğŸŸ¡/ğŸ”´] | - |
| ğŸ§± ç±Œç¢¼çµæ§‹ | [é›†ä¸­ / æ¸™æ•£] | [âœ…/âš ï¸] | - |
| ğŸ“ æ ¸å¿ƒçµè«– | [ä¸€å¥è©±ç²¾ç°¡çµè«–] | - | - |

ğŸ”¥ CIO æ ¸å¿ƒè§€é»ï¼š (ä¸€æ®µè©±è©³ç´°é—¡è¿°)

ç¬¬äºŒæ­¥ï¼šå¤šç¶­åº¦å¥æª¢çŸ©é™£ (Diagnosis Matrix)
(åŒ…å«åŸºæœ¬é¢ã€æŠ€è¡“é¢ã€ç±Œç¢¼é¢çš„ç´…ç¶ ç‡ˆè™Ÿåˆ†æ)

âš–ï¸ åŒæ¥­å°æ¨™èˆ‡ç›¸å°å¼·åº¦ (Peer & Relative Strength)
(æ¯”è¼ƒæœ¬ç›Šæ¯”èˆ‡æ¼²è·Œå¹…)

ğŸ˜ˆ ç´…éšŠæ¸¬è©¦ (Red Team Challenge)
(åå‘æ€è€ƒï¼šç‚ºä»€éº¼ä¸è¦è²·/è³£ï¼Ÿ)

ç¬¬ä¸‰æ­¥ï¼šä¼°å€¼æ¨¡å‹èˆ‡åŠ‡æœ¬æ¨æ¼” (Valuation & Scenarios)
(é ä¼° EPS èˆ‡ åˆç†æœ¬ç›Šæ¯”æ¨ç®—ç›®æ¨™åƒ¹)

ç¬¬å››æ­¥ï¼šç›®æ¨™å°å‘èˆ‡ç­–ç•¥é©é… (Purpose & Fit)
1. é¢¨æ ¼é©é…æ€§æª¢æ ¸
2. ç‹™æ“Šæ‰‹åŸ·è¡Œè¡¨ (è²·é€²/è³£å‡ºå»ºè­°åƒ¹æ ¼)
3. é€±æœŸå°æ‡‰çš„æˆ°è¡“èˆ‡é˜²å®ˆ (åœææ¨™æº–)

âš¡ æœ€çµ‚æ“ä½œæŒ‡ä»¤ï¼š (çµ¦å‡ºæœ€ç›´æ¥çš„ä¸€å€‹å‹•ä½œæŒ‡ä»¤)

ã€è¼¸å‡ºæ ¼å¼è¦æ±‚ã€‘
1. è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
2. å ±å‘Šé–‹é ­ç¬¬ä¸€è¡Œï¼Œè«‹å‹™å¿…ä½¿ç”¨ä¸€ç´šæ¨™é¡Œ (#) æ¸…æ¥šé¡¯ç¤ºï¼šã€Œè‚¡ç¥¨åç¨± (ä»£è™Ÿ)ã€ï¼Œä¾‹å¦‚ï¼šã€Œ# å°ç©é›» (2330) åˆ†æå ±å‘Šã€ã€‚
3. é‡å°æ‰‹æ©Ÿé–±è®€å„ªåŒ–ï¼šè¡¨æ ¼è«‹ç›¡é‡ç²¾ç°¡ï¼ˆæœ€å¤š3-4æ¬„ï¼‰ï¼Œé¿å…éå¯¬å°è‡´è·‘ç‰ˆã€‚
4. è©³ç´°æ•¸æ“šè«‹ç”¨æ¢åˆ—å¼å‘ˆç¾ã€‚
"""

# åˆå§‹åŒ– session state
if "analysis_result" not in st.session_state:
    st.session_state.analysis_result = None

# å´é‚Šæ¬„è¡¨å–®
with st.sidebar:
    st.title("ğŸ“Š åˆ†æåƒæ•¸è¨­å®š")
    st.markdown("---")
    
    stock_code = st.text_input("è‚¡ç¥¨ä»£è™Ÿ", placeholder="ä¾‹å¦‚ï¼š2330")
    holding_cost = st.text_input("æŒæœ‰æˆæœ¬", placeholder="ç©ºæ‰‹æˆ–è¼¸å…¥åƒ¹æ ¼", value="ç©ºæ‰‹")
    holding_shares = st.text_input("æŒæœ‰è‚¡æ•¸", placeholder="ç„¡æˆ–è¼¸å…¥è‚¡æ•¸", value="ç„¡")
    
    st.markdown("---")
    
    operation_period = st.radio("æ“ä½œé€±æœŸ", ["çŸ­ç·š", "ä¸­ç·š", "é•·ç·š"])
    analysis_purpose = st.radio("åˆ†æç›®çš„", ["è©•ä¼°è²·é€²", "è©•ä¼°è³£å‡º"])
    investment_style = st.radio("æŠ•è³‡é¢¨æ ¼", ["ä¿å®ˆé˜²ç¦¦å‹", "ç©©å¥å¹³è¡¡å‹", "ç©æ¥µæ”»æ“Šå‹"])
    
    st.markdown("---")
    analyze_button = st.button("ğŸš€ é–‹å§‹åˆ†æ", type="primary", use_container_width=True)

# ä¸»ç•«é¢
st.title("ğŸ“Š AI é¦–å¸­æŠ•è³‡é•· (CIO) - æˆ°æƒ…å®¤")
st.markdown("---")

if analyze_button:
    if not stock_code:
        st.error("âŒ è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼")
    else:
        user_input = f"""
è‚¡ç¥¨ä»£è™Ÿï¼š{stock_code}
æŒæœ‰æˆæœ¬ï¼š{holding_cost}
ç›®å‰æŒæœ‰è‚¡æ•¸ï¼š{holding_shares}
æ“ä½œé€±æœŸï¼š{operation_period}
åˆ†æç›®çš„ï¼š{analysis_purpose}
æŠ•è³‡é¢¨æ ¼ï¼š{investment_style}
ç•¶å‰æ™‚é–“ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
è«‹ä¾æ“šä»¥ä¸Šè³‡è¨Šé€²è¡Œå®Œæ•´çš„è‚¡ç¥¨åˆ†æã€‚
"""
        
        with st.spinner("ğŸ”„ æ­£åœ¨è¯ç¶²æœå°‹ä¸¦åˆ†æä¸­ (ä½¿ç”¨ç¶“å…¸ç©©å®šç‰ˆå¼•æ“)..."):
            try:
                # è¨­å®šæ¨¡å‹åƒæ•¸ (ç¶“å…¸ç‰ˆ)
                model = genai.GenerativeModel(
                    model_name=MODEL_NAME,
                    system_instruction=SYSTEM_INSTRUCTION
                )
                
                # é€™è£¡åŸæœ¬éœ€è¦ tools='google_search_retrieval'
                # ä½†ç‚ºäº†é¿å…ä»»ä½•å·¥å…·éŒ¯èª¤ï¼Œæˆ‘å€‘å…ˆç”¨ç´”æ¨¡å‹ç”Ÿæˆï¼Œä¸¦å¼·çƒˆæš—ç¤ºå®ƒç”¨å…§å»ºçŸ¥è­˜
                # è‹¥è¦å•Ÿç”¨æœå°‹ï¼Œç¶“å…¸ç‰ˆé€šå¸¸æœƒè‡ªå‹•è§¸ç™¼(è‹¥æœ‰è¨­å®š)æˆ–éœ€è¦é¡å¤–è¨­å®š
                # ç‚ºäº†ç¢ºä¿ã€Œä¸€å®šèƒ½è·‘ã€ï¼Œæˆ‘å€‘å…ˆç”¨æœ€å–®ç´”çš„ generate_content
                
                response = model.generate_content(user_input)
                
                if response.text:
                    st.session_state.analysis_result = response.text
                else:
                    st.error("âš ï¸ AI æ²’æœ‰å›å‚³æ–‡å­—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚")
                
            except Exception as e:
                st.error(f"âŒ åˆ†æéŒ¯èª¤ï¼š{str(e)}")
                st.session_state.analysis_result = None

if st.session_state.analysis_result:
    st.markdown(st.session_state.analysis_result)
elif not analyze_button:
    st.info("ğŸ‘ˆ è«‹åœ¨å·¦å´è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿä¸¦é–‹å§‹åˆ†æã€‚")